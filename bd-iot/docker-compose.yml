version: '3'
services:
  
    node-red:
      image: nodered/node-red
      container_name: nodered
      volumes:
        - nodered_data:/data
      ports:
        - "1881:1880"
      networks:
        - net_bd

    namenode:
      image: owuor/hdfs-namenode
      container_name: namenode
      restart: always
      ports:
        - 9870:9870
        - 9000:9000
      volumes:
        - hadoop_namenode:/hadoop/dfs/name
      environment:
        - CLUSTER_NAME=test
      env_file:
        - ./configs/hadoop.env
      networks:
        - net_bd

    datanode:
      image: owuor/hdfs-datanode
      container_name: datanode
      restart: always
      ports:
        - 9864:9864
      volumes:
        - hadoop_datanode:/hadoop/dfs/data
      depends_on:
        - namenode
      environment:
        SERVICE_PRECONDITION: "namenode:9870"
      env_file:
        - ./configs/hadoop.env
      networks:
        - net_bd

    zeppelin:
      image: apache/zeppelin:0.8.0
      container_name: zeppelin
      volumes:
        - ./configs/zeppelin/notebook:/opt/zeppelin/notebook
        - ./configs/zeppelin/conf:/opt/zeppelin/conf
        - zeppelin_logs:/opt/zeppelin/logs
      ports:
        - "8082:8080"
      environment:
        - CORE_CONF_fs_defaultFS=hdfs://namenode:9000
      networks:
        - net_bd

    streamsets:
      image: streamsets/datacollector:3.13.0-latest
      container_name: streamsets
      ports:
        - "18630:18630"
      networks:
        - net_bd

    zookeeper:
      image: bitnami/zookeeper:latest #3.7.1
      container_name: zookeeper
      ports:
        - 2181:2181
      environment:
        - ALLOW_ANONYMOUS_LOGIN=yes
      networks:
        - net_bd

    kafka:
      image: owuor/kafka:3.3.2
      container_name: kafka
      ports:
        - 9092:9092
      environment:
        - KAFKA_CFG_ZOOKEEPER_CONNECT=zookeeper:2181
        - ALLOW_PLAINTEXT_LISTENER=yes
        - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CLIENT:PLAINTEXT,EXTERNAL:PLAINTEXT
        - KAFKA_CFG_LISTENERS=CLIENT://:9092,EXTERNAL://:9093
        - KAFKA_CFG_ADVERTISED_LISTENERS=CLIENT://kafka:9092,EXTERNAL://localhost:9093
        - KAFKA_INTER_BROKER_LISTENER_NAME=CLIENT
        - KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE=true
        - KAFKA_BROKER_ID=1
        - IOT_TOPIC_NAME=iot-temp
      #env_file:
      #  - ./configs/kafka.env
      depends_on:
        - zookeeper
      networks:
        - net_bd

    #kafka:
    #  image: bitnami/kafka:latest
    #  container_name: kafka
    #  ports:
    #    - 9092:9092
    #  environment:
    #    - KAFKA_CFG_ZOOKEEPER_CONNECT=zookeeper:2181
    #    - ALLOW_PLAINTEXT_LISTENER=yes
    #    - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CLIENT:PLAINTEXT,EXTERNAL:PLAINTEXT
    #    - KAFKA_CFG_LISTENERS=CLIENT://:9092,EXTERNAL://:9093
    #    - KAFKA_CFG_ADVERTISED_LISTENERS=CLIENT://kafka:9092,EXTERNAL://localhost:9093
    #    - KAFKA_INTER_BROKER_LISTENER_NAME=CLIENT
    #    - KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE=true
        # - KAFKA_BROKER_ID=1
    #  depends_on:
    #    - zookeeper
    #  networks:
    #    - net_bd

    # create kafka IoT topic
    #kafka-init:
    #  image: bitnami/kafka:latest
    #  container_name: kafka-init
    #  command: [ "/bin/bash", "-c", "chmod +x /kafka_topic.sh && sh /kafka_topic.sh"]
    #  environment:
    #    - KAFKA_CFG_ZOOKEEPER_CONNECT=zookeeper:2181
    #    - IOT_TOPIC_NAME=iot-temp
    #  depends_on:
    #    - kafka
    #  volumes:
    #    - type: bind
    #      source: ./configs/kafka_topic.sh
    #      target: /kafka_topic.sh
    #  init: true
    #  networks:
    #    - net_bd

volumes:
    nodered_data: {}
    zeppelin_logs: {}
    hadoop_datanode: {}
    hadoop_namenode: {}

networks:
  net_bd:
    name: net_bd
    driver: bridge
